#this file fits biphasic exponential decays to the patients' antibody decay data
#install.packages("minpack.lm")
library(minpack.lm)

#inputs antibody data for each patient
get20 = function(){
  x = c(0.17391304347826164, 1.0434782608695592, 2.086956521739129, 7.0724637681159415, 
          14.086956521739129, 21.101449275362317, 35.13043478260869, 42.144927536231876, 
          49.217391304347814)
  conc = c(10^2.878626706064444, 10^2.607626283945406, 10^2.395047136625862, 10^2.021246658224286,
           10^1.6591248065287747, 10^1.4620514985225834, 10^0.931982552413114, 10^0.8222878851836217,
           10^-1.0155058393133531)
  ab20 = data.frame(x, conc)
  plot(ab20$x, ab20$conc, type='o')
  return(ab20)
}
get21 = function(){
  x = c(0.7802814418754558, 1.591116072740057, 2.575281294985132, 7.48318105702279,
          14.435206674696644, 21.426011339933574, 28.455007491406896, 35.30244719292575, 
          42.28267575428185, 49.316372396368855)
  conc = c(10^3.096213167249328, 10^2.9274949322835537, 10^2.7190869296982836, 10^2.568142424865592,
             10^2.138958253767734, 10^2.036487558388904, 10^1.7557801345515416, 10^1.4454596198478198,
             10^1.2538852492728916, 10^1.0127794588560164)
  ab21 = data.frame(x, conc)
  plot(ab21$x, ab21$conc, type='o')
  return(ab21)
}
get22 = function(){
  x = c(-0.03296391020175804, 0.846831486217674, 1.7834612105711898, 6.795112247797675, 
          13.768684285308325, 20.80534242682581, 27.783461210571183, 34.75589656152317, 
          48.84114805342428)
  conc = c(10^3.068627450980393, 10^2.8921568627450984, 10^2.7352941176470593, 10^2.2843137254901964,
             10^1.990196078431373, 10^1.607843137254902, 10^1.2352941176470589, 10^0.9607843137254903,
             10^-1.0098039215686274)
  ab22 = data.frame(x, conc)
  plot(ab22$x, ab22$conc, type='o')
  return(ab22)
}
get23 = function(){
  x = c(0.630407229845158, 1.5220146580702085, 2.530445803714116, 7.416101835014057, 
          14.34837714222736, 21.374331845484104, 28.319832479197668, 35.29178376591173, 
          42.25491816829229, 49.11335206921255)
  conc = c(10^2.9737697691078413, 10^2.753044580371411, 10^2.551606326114509, 10^2.1789551992064804,
             10^1.6630572546426405, 10^1.464512040557668, 10^1.0640050697084922, 10^0.8942800462886433,
             10^0.647627707059018, 10^-1.012536507411693)
  ab23 = data.frame(x, conc)
  plot(ab23$x, ab23$conc, type='o')
  return(ab23)
}
get24 = function(){
  x = c(-0.030392570704911748, 0.8554945828057079, 1.7897847192908678, 6.856338820880843, 
          13.89221893907417, 20.86281131279022, 27.887434923315055, 34.860841423948216, 
          41.88602785985648, 48.90671169269734)
  conc = c(10^3.0291262135922334, 10^2.7475728155339807, 10^2.6310679611650487, 10^2.2330097087378644,
             10^1.8640776699029127, 10^1.621359223300971, 10^1.4466019417475726, 10^1.155339805825243,
             10^0.970873786407767, 10^0.8640776699029122)
  ab24 = data.frame(x, conc)
  plot(ab24$x, ab24$conc, type='o')
  return(ab24)
}
get25 = function(){
  x = c(-0.2966920541093927, 0.46720472888480913, 6.581789246333948, 11.598272138228921, 
          15.631465272251873, 20.641127657155828, 27.67989087188812, 34.722064340115935, 
          41.748323292031344)
  conc = c(10^3.0662725929294115, 10^2.9776628396044145, 10^2.239371376605664, 10^1.9722064340115977,
             10^1.6859156530635473, 10^1.477577583267025, 10^1.2682448562009792, 10^1.029498692736162,
             10^0.9280152324656146)
  ab25 = data.frame(x, conc)
  plot(ab25$x, ab25$conc, type='o')
  return(ab25)
}
get26 = function(){
  x= c(0.43955425484015365, 1.2336785231877485, 7.232665466006299, 14.169293111211157, 
          21.112674470959018, 28.1691805493021, 35.11650157586671, 42.16850517784779, 
          49.11019810895991)
  conc = c(10^3.104176046825753, 10^2.8028196758217008, 10^2.2853444394416917, 10^1.9421713192255732,
             10^1.7154997748761809, 10^1.4402296262944612, 10^1.2815173345339925, 10^0.92857946870779,
             10^0.6727825303917143)
  ab26 = data.frame(x, conc)
  plot(ab26$x, ab26$conc, type='o')
  return(ab26)
}
get27 = function(){
  x = c(0.2352941176470651, 1.058823529411768, 2.000000000000007, 6.941176470588239, 
          14, 20.941176470588232, 27.94117647058824, 34.94117647058823, 
          41.882352941176464, 48.94117647058823)
  conc = c(10^3.090801614763553, 10^2.8166955017301043, 10^2.689705882352942, 10^2.3587946943483282,
             10^2.107352941176471, 10^1.8754613610149944, 10^1.6141868512110729, 10^1.5097750865051904,
             10^1.2778835063437137, 10^1.0950692041522485)
  ab27 = data.frame(x, conc)
  plot(ab27$x, ab27$conc, type='o')
  return(ab27)
}

#create the data sets
ab20 = get20()
ab21 = get21()
ab22 = get22()
ab23 = get23()
ab24 = get24()
ab25 = get25()
ab26 = get26()
ab27 = get27()

#this function takes in a data set with concentration over time and the patient number
#it returns a biphasic fit for the data and graphs it
getfit = function(ab, n){
  decay = nlsLM(data=ab, ab$conc ~ a*exp(r1*(ab$x)) + 
                    a*b*exp(r2*(ab$x)), start=c(r1=-.5, r2=0, a=1000, b=200))
  plot(ab$x, ab$conc, xlab="days after VRC01 infusion", ylab="Ab concentration")
  title(paste("#",n))
  modtime = seq(ab$x[1],ab$x[length(ab$x)], .01)
  r1 = coef(decay)[1]
  r2 = coef(decay)[2]
  a = coef(decay)[3]
  b = coef(decay)[4]
  moddecay = a*exp(r1*(modtime)) + a*b*exp(r2*(modtime))
  lines(modtime, moddecay, type='l', col="red")
  return(decay)
}

#fitting each patient's ab data
par(mfrow=c(2,2))
decay20 = getfit(ab20, 20)
decay21 = getfit(ab21, 21)
decay22 = getfit(ab22, 22)
decay23 = getfit(ab23, 23)
decay24 = getfit(ab24, 24)
decay25 = getfit(ab25, 25)
decay26 = getfit(ab26, 26)
decay27 = getfit(ab27, 27)

#this compiles all of the parameters and calculates the average values
r1s = c(coef(decay20)[1], coef(decay21)[1], coef(decay22)[1], coef(decay23)[1],
        coef(decay24)[1], coef(decay25)[1], coef(decay26)[1], coef(decay27)[1]) 
r2s = c(coef(decay20)[2], coef(decay21)[2], coef(decay22)[2], coef(decay23)[2],
        coef(decay24)[2], coef(decay25)[2], coef(decay26)[2], coef(decay27)[2])
as = c(coef(decay20)[3], coef(decay21)[3], coef(decay22)[3], coef(decay23)[3],
       coef(decay24)[3], coef(decay25)[3], coef(decay26)[3], coef(decay27)[3])
bs = c(coef(decay20)[4], coef(decay21)[4], coef(decay22)[4], coef(decay23)[4],
       coef(decay24)[4], coef(decay25)[4], coef(decay26)[4], coef(decay27)[4])
r1ave = mean(r1s)
r2ave = mean(r2s)
aave = mean(as)
bave = mean(bs)

